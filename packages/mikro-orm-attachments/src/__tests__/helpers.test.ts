import { describe, it, expect, beforeEach, mock } from "bun:test";
import { use, imageToBlurhash } from "../utils/helpers";

describe("helpers", () => {
	describe("use", () => {
		it("should import module with default export", async () => {
			const module = await use("sharp");
			expect(module).toBeDefined();
		});

		it("should import module without default export", async () => {
			const result = await use("blurhash");
			expect(result).toBeDefined();
		});

		it("should throw error for non-existent module", async () => {
			await expect(use("non-existent-module-12345")).rejects.toThrow("Module non-existent-module-12345 not found");
		});
	});

	describe("imageToBlurhash", () => {
		it("should generate blurhash from image buffer", async () => {
			const imageBuffer = Buffer.from([
				0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
				0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,
				0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,
				0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,
				0x42, 0x60, 0x82,
			]);
			const blurhash = await imageToBlurhash(imageBuffer);
			expect(typeof blurhash).toBe("string");
			expect(blurhash.length).toBeGreaterThan(0);
		});

		it("should generate blurhash with custom options", async () => {
			const imageBuffer = Buffer.from([
				0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
				0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,
				0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,
				0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,
				0x42, 0x60, 0x82,
			]);
			const blurhash = await imageToBlurhash(imageBuffer, {
				enabled: true,
				componentX: 3,
				componentY: 3,
			});
			expect(typeof blurhash).toBe("string");
			expect(blurhash.length).toBeGreaterThan(0);
		});

		it("should use default options when not provided", async () => {
			const imageBuffer = Buffer.from([
				0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
				0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x08, 0x06, 0x00, 0x00, 0x00, 0x1f, 0x15, 0xc4,
				0x89, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41, 0x54, 0x78, 0x9c, 0x63, 0x00, 0x01, 0x00, 0x00,
				0x05, 0x00, 0x01, 0x0d, 0x0a, 0x2d, 0xb4, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,
				0x42, 0x60, 0x82,
			]);
			const blurhash = await imageToBlurhash(imageBuffer);
			expect(typeof blurhash).toBe("string");
		});

		it("should handle invalid image buffer", async () => {
			const invalidBuffer = Buffer.from("invalid image data");
			await expect(imageToBlurhash(invalidBuffer)).rejects.toThrow();
		});
	});
});
